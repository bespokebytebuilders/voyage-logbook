<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voyage Logbook - Make Your Dreams Reality</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/api.js"></script>
    <style>
        :root {
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-success: #10b981;
            --color-background: #f8fafc;
            --color-surface: #ffffff;
            --color-text: #1e293b;
            --color-text-secondary: #64748b;
            --color-border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, #8b5cf6 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Auth Section */
        .auth-container {
            max-width: 400px;
            margin: 40px auto;
            background: var(--color-surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: var(--color-background);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--color-primary);
            color: white;
        }

        /* Navigation */
        .nav {
            background: var(--color-surface);
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-left {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            padding: 8px 16px;
            background: var(--color-background);
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--color-background);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-text);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Cards */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--color-primary);
        }

        .card-location {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            margin-bottom: 10px;
        }

        .card-why {
            margin: 15px 0;
            color: var(--color-text);
        }

        .card-progress {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--color-text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-background);
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-success));
            transition: width 0.3s;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--color-text-secondary);
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--color-text);
        }

        /* Map */
        #map {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* How Steps */
        .how-steps {
            margin-top: 20px;
        }

        .how-step {
            background: var(--color-background);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .how-step-content {
            flex: 1;
        }

        .how-step-actions {
            display: flex;
            gap: 10px;
        }

        .step-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .step-completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        /* Motivational Questions */
        .question-section {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .question-section h4 {
            margin-bottom: 10px;
            color: #92400e;
        }

        /* Statistics */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-label {
            color: var(--color-text-secondary);
            margin-top: 5px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üåü Voyage Logbook</h1>
        <p>Turn your dreams into reality, one step at a time</p>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="auth-container">
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="loginPassword" class="form-input" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="hidden">
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" id="signupName" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="signupEmail" class="form-input" required>
            </div>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" id="signupPassword" class="form-input" required>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%;">Create Account</button>
        </form>
    </div>

    <!-- Main App (Hidden until logged in) -->
    <div id="mainApp" class="hidden">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-left">
                <button class="btn btn-primary btn-small" onclick="openCreateModal()">+ New Logbook Item</button>
                <button class="btn btn-secondary btn-small" onclick="showView('list')">My List</button>
                <button class="btn btn-secondary btn-small" onclick="showView('stats')">Statistics</button>
            </div>
            <div class="nav-right">
                <span class="user-info" id="userInfo"></span>
                <button class="btn btn-success btn-small" onclick="generateLogbook()">üìñ Order Logbook</button>
                <button class="btn btn-secondary btn-small" onclick="logout()">Logout</button>
            </div>
        </nav>

        <!-- Main Container -->
        <div class="container">
            <!-- List View -->
            <div id="listView">
                <div id="bucketListCards" class="cards-grid"></div>
                <div id="emptyState" class="empty-state hidden">
                    <h3>üéØ Start Your Journey!</h3>
                    <p>Create your first logbook item and begin making your dreams come true.</p>
                    <button class="btn btn-primary" onclick="openCreateModal()" style="margin-top: 20px;">Create Your First Item</button>
                </div>
            </div>

            <!-- Stats View -->
            <div id="statsView" class="hidden">
                <h2 style="margin-bottom: 20px;">Your Progress</h2>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="totalItems">0</div>
                        <div class="stat-label">Total Dreams</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completedItems">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="inProgressItems">0</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-label">Completion Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Create Logbook Item</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <form id="itemForm">
                <div class="form-group">
                    <label class="form-label">What's your dream? *</label>
                    <input type="text" id="itemTitle" class="form-input" placeholder="e.g., Visit the Northern Lights" required>
                </div>

                <div class="question-section">
                    <h4>üí≠ Why does this matter to you?</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">Think deeply - what will this experience bring to your life?</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Why do you want to accomplish this? *</label>
                    <textarea id="itemWhy" class="form-textarea" placeholder="Share your heart... What feelings will this bring? Why is this important to your life story?" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Where will this happen? *</label>
                    <input type="text" id="itemLocation" class="form-input" placeholder="e.g., Troms√∏, Norway" required>
                    <div id="map"></div>
                </div>

                <div class="question-section">
                    <h4>üéØ How will you make this happen?</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">Break down your dream into actionable steps. What's the first thing you can do today?</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Action Steps (How)</label>
                    <div id="howSteps"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addHowStep()" style="margin-top: 10px;">+ Add Step</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Target Date (Optional)</label>
                    <input type="date" id="itemTargetDate" class="form-input">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Dream</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Item Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="viewTitle"></h2>
                <button class="close-btn" onclick="closeViewModal()">&times;</button>
            </div>

            <div id="viewContent"></div>

            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-primary" onclick="editCurrentItem()">Edit</button>
                <button class="btn btn-secondary" style="background: #ef4444; color: white;" onclick="deleteCurrentItem()">Delete</button>
                <button class="btn btn-secondary" onclick="closeViewModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let currentUser = null;
        let bucketListItems = [];
        let currentItemId = null;
        let map = null;
        let marker = null;
        let currentView = 'list';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadFromStorage();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);
            document.getElementById('itemForm').addEventListener('submit', handleItemSubmit);
        }

        // Auth Functions
        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
                document.getElementById('signupForm').classList.add('hidden');
            } else {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('signupForm').classList.remove('hidden');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const user = await authAPI.login(email, password);
                currentUser = user;
                showMainApp();
            } catch (error) {
                alert(error.message || 'Invalid credentials. Please try again or sign up.');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            try {
                const user = await authAPI.register(name, email, password);
                currentUser = user;
                showMainApp();
            } catch (error) {
                alert(error.message || 'Failed to create account. Please try again.');
            }
        }

        function logout() {
            currentUser = null;
            bucketListItems = [];
            authAPI.logout();
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }

        async function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `üëã ${currentUser.name}`;
            await loadUserData();
            renderBucketList();
            updateStatistics();
        }

        // Data Management
        async function loadFromStorage() {
            const savedUser = localStorage.getItem('currentUser');
            const token = localStorage.getItem('authToken');
            
            if (savedUser && token) {
                try {
                    currentUser = JSON.parse(savedUser);
                    await loadUserData();
                    // If successful, show app
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    document.getElementById('userInfo').textContent = `üëã ${currentUser.name}`;
                    renderBucketList();
                    updateStatistics();
                } catch (error) {
                    // Token invalid, clear it
                    console.error('Failed to load data:', error);
                    authAPI.logout();
                }
            }
        }

        async function loadUserData() {
            try {
                bucketListItems = await itemsAPI.getAll();
            } catch (error) {
                console.error('Failed to load user data:', error);
                bucketListItems = [];
                throw error;
            }
        }

        // View Management
        function showView(view) {
            currentView = view;
            document.getElementById('listView').classList.add('hidden');
            document.getElementById('statsView').classList.add('hidden');

            if (view === 'list') {
                document.getElementById('listView').classList.remove('hidden');
            } else if (view === 'stats') {
                document.getElementById('statsView').classList.remove('hidden');
                updateStatistics();
            }
        }

        // Modal Management
        function openCreateModal() {
            currentItemId = null;
            document.getElementById('modalTitle').textContent = 'Create Logbook Item';
            document.getElementById('itemForm').reset();
            document.getElementById('howSteps').innerHTML = '';
            addHowStep();
            document.getElementById('itemModal').classList.add('active');
            
            setTimeout(() => {
                initMap();
            }, 100);
        }

        function closeModal() {
            document.getElementById('itemModal').classList.remove('active');
            if (map) {
                map.remove();
                map = null;
            }
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        // Map Functions
        function initMap() {
            if (map) {
                map.remove();
            }

            map = L.map('map').setView([40, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            map.on('click', function(e) {
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker(e.latlng).addTo(map);
            });

            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        // How Steps Management
        function addHowStep(text = '', completed = false) {
            const stepsContainer = document.getElementById('howSteps');
            const stepId = Date.now().toString() + Math.random();
            
            const stepDiv = document.createElement('div');
            stepDiv.className = 'how-step';
            stepDiv.dataset.stepId = stepId;
            
            stepDiv.innerHTML = `
                <div class="how-step-content">
                    <input type="text" class="form-input" placeholder="Describe an action step..." value="${text}" ${completed ? 'disabled' : ''}>
                </div>
                <div class="how-step-actions">
                    <button type="button" class="btn btn-secondary btn-small" onclick="removeHowStep('${stepId}')">Remove</button>
                </div>
            `;
            
            stepsContainer.appendChild(stepDiv);
        }

        function removeHowStep(stepId) {
            const step = document.querySelector(`[data-step-id="${stepId}"]`);
            if (step) {
                step.remove();
            }
        }

        function getHowSteps() {
            const steps = [];
            const stepElements = document.querySelectorAll('#howSteps .how-step');
            
            stepElements.forEach(stepEl => {
                const input = stepEl.querySelector('input');
                if (input.value.trim()) {
                    steps.push({
                        id: stepEl.dataset.stepId,
                        text: input.value.trim(),
                        completed: false
                    });
                }
            });
            
            return steps;
        }

        // Item Management
        async function handleItemSubmit(e) {
            e.preventDefault();

            const itemData = {
                title: document.getElementById('itemTitle').value,
                why: document.getElementById('itemWhy').value,
                location: document.getElementById('itemLocation').value,
                targetDate: document.getElementById('itemTargetDate').value || null,
                howSteps: getHowSteps(),
                coordinates: marker ? {
                    lat: marker.getLatLng().lat,
                    lng: marker.getLatLng().lng
                } : null
            };

            try {
                let savedItem;
                if (currentItemId) {
                    savedItem = await itemsAPI.update(currentItemId, itemData);
                    const index = bucketListItems.findIndex(i => i.id === currentItemId);
                    bucketListItems[index] = savedItem;
                } else {
                    savedItem = await itemsAPI.create(itemData);
                    bucketListItems.push(savedItem);
                }

                renderBucketList();
                updateStatistics();
                closeModal();
            } catch (error) {
                alert(error.message || 'Failed to save item. Please try again.');
            }
        }

        function viewItem(itemId) {
            const item = bucketListItems.find(i => i.id === itemId);
            if (!item) return;

            currentItemId = itemId;
            document.getElementById('viewTitle').textContent = item.title;

            const completedSteps = item.howSteps.filter(s => s.completed).length;
            const totalSteps = item.howSteps.length;
            const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

            let stepsHTML = '';
            if (item.howSteps.length > 0) {
                stepsHTML = '<div class="how-steps">';
                item.howSteps.forEach(step => {
                    stepsHTML += `
                        <div class="how-step ${step.completed ? 'step-completed' : ''}">
                            <div class="how-step-content">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" class="step-checkbox" ${step.completed ? 'checked' : ''} 
                                           onchange="toggleStepCompletion('${item.id}', '${step.id}')">
                                    <span>${step.text}</span>
                                </label>
                            </div>
                        </div>
                    `;
                });
                stepsHTML += '</div>';
            }

            const content = `
                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--color-text-secondary);">üìç Location:</strong>
                    <p>${item.location}</p>
                </div>

                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--color-text-secondary);">üí≠ Why This Matters:</strong>
                    <p style="font-style: italic; padding: 15px; background: var(--color-background); border-radius: 8px; margin-top: 10px;">
                        ${item.why}
                    </p>
                </div>

                ${item.targetDate ? `
                    <div style="margin-bottom: 20px;">
                        <strong style="color: var(--color-text-secondary);">üéØ Target Date:</strong>
                        <p>${new Date(item.targetDate).toLocaleDateString()}</p>
                    </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <strong style="color: var(--color-text-secondary);">üìã Action Steps:</strong>
                    <div style="margin-top: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%;"></div>
                        </div>
                        <p style="font-size: 0.9rem; margin-top: 5px; color: var(--color-text-secondary);">
                            ${completedSteps} of ${totalSteps} steps completed (${progress}%)
                        </p>
                    </div>
                    ${stepsHTML}
                </div>
            `;

            document.getElementById('viewContent').innerHTML = content;
            document.getElementById('viewModal').classList.add('active');
        }

        async function toggleStepCompletion(itemId, stepId) {
            try {
                await itemsAPI.toggleStep(itemId, stepId);
                // Reload item data
                const item = bucketListItems.find(i => i.id === itemId);
                if (item) {
                    const step = item.howSteps.find(s => s.id === stepId);
                    if (step) {
                        step.completed = !step.completed;
                    }
                }
                viewItem(itemId);
                renderBucketList();
                updateStatistics();
            } catch (error) {
                alert(error.message || 'Failed to update step. Please try again.');
            }
        }

        function editCurrentItem() {
            closeViewModal();
            const item = bucketListItems.find(i => i.id === currentItemId);
            if (!item) return;

            document.getElementById('modalTitle').textContent = 'Edit Logbook Item';
            document.getElementById('itemTitle').value = item.title;
            document.getElementById('itemWhy').value = item.why;
            document.getElementById('itemLocation').value = item.location;
            document.getElementById('itemTargetDate').value = item.targetDate || '';

            document.getElementById('howSteps').innerHTML = '';
            item.howSteps.forEach(step => {
                addHowStep(step.text, step.completed);
            });

            document.getElementById('itemModal').classList.add('active');
            
            setTimeout(() => {
                initMap();
                if (item.coordinates) {
                    map.setView([item.coordinates.lat, item.coordinates.lng], 10);
                    marker = L.marker([item.coordinates.lat, item.coordinates.lng]).addTo(map);
                }
            }, 100);
        }

        async function deleteCurrentItem() {
            if (confirm('Are you sure you want to delete this logbook item?')) {
                try {
                    await itemsAPI.delete(currentItemId);
                    bucketListItems = bucketListItems.filter(i => i.id !== currentItemId);
                    renderBucketList();
                    updateStatistics();
                    closeViewModal();
                } catch (error) {
                    alert(error.message || 'Failed to delete item. Please try again.');
                }
            }
        }

        // Rendering
        function renderBucketList() {
            const container = document.getElementById('bucketListCards');
            const emptyState = document.getElementById('emptyState');

            if (bucketListItems.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            container.innerHTML = bucketListItems.map(item => {
                const completedSteps = item.howSteps.filter(s => s.completed).length;
                const totalSteps = item.howSteps.length;
                const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

                return `
                    <div class="card" onclick="viewItem('${item.id}')">
                        <h3 class="card-title">${item.title}</h3>
                        <p class="card-location">üìç ${item.location}</p>
                        <p class="card-why" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                            "${item.why}"
                        </p>
                        ${item.targetDate ? `
                            <p style="font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 10px;">
                                üéØ Target: ${new Date(item.targetDate).toLocaleDateString()}
                            </p>
                        ` : ''}
                        <div class="card-progress">
                            <span>Progress: ${completedSteps}/${totalSteps} steps</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%;"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStatistics() {
            const total = bucketListItems.length;
            const completed = bucketListItems.filter(item => {
                const totalSteps = item.howSteps.length;
                const completedSteps = item.howSteps.filter(s => s.completed).length;
                return totalSteps > 0 && completedSteps === totalSteps;
            }).length;
            const inProgress = total - completed;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('completedItems').textContent = completed;
            document.getElementById('inProgressItems').textContent = inProgress;
            document.getElementById('completionRate').textContent = rate + '%';
        }

        // Logbook Generation
        function generateLogbook() {
            if (bucketListItems.length === 0) {
                alert('Create some logbook items first before generating your logbook!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let yPos = 20;

            // Title Page
            doc.setFontSize(24);
            doc.text('My Voyage Logbook', 105, yPos, { align: 'center' });
            yPos += 10;
            doc.setFontSize(12);
            doc.text(`Created by: ${currentUser.name}`, 105, yPos, { align: 'center' });
            yPos += 10;
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 105, yPos, { align: 'center' });

            // Add each logbook item
            bucketListItems.forEach((item, index) => {
                doc.addPage();
                yPos = 20;

                // Title
                doc.setFontSize(18);
                doc.text(item.title, 20, yPos);
                yPos += 15;

                // Location
                doc.setFontSize(12);
                doc.text(`Location: ${item.location}`, 20, yPos);
                yPos += 10;

                // Why
                doc.text('Why this matters to me:', 20, yPos);
                yPos += 7;
                doc.setFontSize(10);
                const whyLines = doc.splitTextToSize(item.why, 170);
                doc.text(whyLines, 20, yPos);
                yPos += whyLines.length * 5 + 10;

                // How Steps
                doc.setFontSize(12);
                doc.text('Action Steps:', 20, yPos);
                yPos += 7;
                doc.setFontSize(10);
                
                item.howSteps.forEach((step, i) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    const checkbox = step.completed ? '[X]' : '[ ]';
                    doc.text(`${checkbox} ${i + 1}. ${step.text}`, 25, yPos);
                    yPos += 7;
                });

                // Add blank journaling pages
                doc.addPage();
                doc.setFontSize(12);
                doc.text(`Journey Notes for: ${item.title}`, 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text('Use this space to document your journey...', 20, 35);
                
                // Draw lines for writing
                for (let i = 45; i < 280; i += 10) {
                    doc.line(20, i, 190, i);
                }
            });

            // Save PDF
            doc.save(`bucket-list-logbook-${Date.now()}.pdf`);
            
            alert('üéâ Your logbook has been generated! This PDF is ready to be printed and used as your personal journey companion. Consider ordering a professionally bound version!');
        }
    </script>
</body>
</html>

